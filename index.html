<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weekly Average Sentiment</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .area {
            opacity: 0.7;
        }
        .axis-label {
            font-size: 12px;
            fill: #333;
        }
        .tooltip {
            position: absolute;
            background-color: white;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            color: #333;
        }
    </style>
</head>
<body>
    <h2 id="chart-title">Weekly Average Sentiment - Palestine</h2>

    <label for="dataset-select">Choose a topic:</label>
    <select id="dataset-select">
        <option value="palestine_sentiment.csv">Palestine</option>
        <option value="ukraine_sentiment.csv">Ukraine</option>
        <option value="trump_sentiment.csv">Trump</option>
    </select>

    <div id="chart"></div>
    <div id="tooltip" class="tooltip" style="opacity: 0;"></div>

    <script>
        const margin = { top: 20, right: 30, bottom: 50, left: 50 },
              width = 960 - margin.left - margin.right,
              height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
                      .append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");
        const titleElement = document.getElementById("chart-title");
        const selectElement = document.getElementById("dataset-select");

        function loadData(fileName) {
            d3.csv(fileName, d => {
                d.created = new Date(d.created);
                for (let key in d) {
                    if (key !== "created" && key !== "comment") {
                        d[key] = +d[key];
                    }
                }
                return d;
            }).then(data => {
                // Process weekly aggregation
                const weeklyData = d3.rollups(
                    data,
                    group => {
                        const totalComments = group.length;
                        const weekData = { totalComments };
                        group.forEach(entry => {
                            for (let key in entry) {
                                if (key !== "created" && key !== "comment") {
                                    weekData[key] = (weekData[key] || 0) + entry[key] / totalComments;
                                }
                            }
                        });
                        return weekData;
                    },
                    d => d3.timeFormat("%Y-%U")(d.created)
                ).map(([week, values]) => ({
                    week: d3.timeParse("%Y-%U")(week),
                    ...values
                }));

                updateChart(weeklyData);
            });
        }

        function updateChart(data) {
            svg.selectAll("*").remove();

            const emotions = Object.keys(data[0]).filter(key => key !== "week" && key !== "totalComments" && key !== "neutral");
            data.forEach(d => {
              let totalScore = d3.sum(emotions, key => d[key]);
              emotions.forEach(key => {
                d[key] = d[key] / totalScore;
              });
            });
            const x = d3.scaleTime()
                        .domain(d3.extent(data, d => d.week))
                        .range([0, width]);

            const y = d3.scaleLinear()
                        .domain([0, d3.max(data, d => d3.sum(emotions, key => d[key]))])
                        .range([height, 0]);

            const color = d3.scaleOrdinal()
                            .domain(emotions)
                            .range(d3.schemeCategory10);

            const area = d3.area()
                           .x(d => x(d.data.week))
                           .y0(d => y(d[0]))
                           .y1(d => y(d[1]));

            const stack = d3.stack()
                            .keys(emotions)
                            .order(d3.stackOrderNone)
                            .offset(d3.stackOffsetNone);

            const stackedData = stack(data);

            svg.selectAll(".area")
               .data(stackedData)
               .enter().append("path")
               .attr("class", "area")
               .attr("d", area)
               .attr("fill", d => color(d.key))
               .on("mouseover", (event, d) => {
                   tooltip.style("opacity", 1);
               })
               .on("mousemove", (event, d) => {
                   const [xPos] = d3.pointer(event, svg.node());
                   const date = x.invert(xPos);
                   const roundedWeek = d3.timeFormat("%Y-%U")(date);

                   const dataAtWeek = data.find(item => d3.timeFormat("%Y-%U")(item.week) === roundedWeek);
                   const emotion = d.key;
                   const score = dataAtWeek ? dataAtWeek[emotion] : 0;
                   const totalComments = dataAtWeek ? dataAtWeek.totalComments : 0;

                   tooltip.html(`<strong>Week:</strong> ${roundedWeek}<br>
                                 <strong>Emotion:</strong> ${emotion}<br>
                                 <strong>Score:</strong> ${score.toFixed(2)}<br>
                                 <strong>Total Comments:</strong> ${totalComments}`)
                          .style("left", (event.pageX + 15) + "px")
                          .style("top", (event.pageY - 30) + "px");
               })
               .on("mouseout", () => {
                   tooltip.style("opacity", 0);
               });

            svg.append("g")
               .attr("transform", `translate(0,${height})`)
               .call(d3.axisBottom(x).ticks(10))
               .selectAll("text")
               .style("text-anchor", "end")
               .attr("dx", "-0.8em")
               .attr("dy", "0.15em")
               .attr("transform", "rotate(-45)");

            svg.append("g")
               .call(d3.axisLeft(y));

            svg.append("text")
               .attr("class", "axis-label")
               .attr("x", width / 2)
               .attr("y", height + margin.bottom - 10)
               .style("text-anchor", "middle")
               .text("Week");

            svg.append("text")
               .attr("class", "axis-label")
               .attr("transform", "rotate(-90)")
               .attr("y", -margin.left + 15)
               .attr("x", -height / 2)
               .style("text-anchor", "middle")
               .text("Average Sentiment Score");
        }

        selectElement.addEventListener("change", () => {
            const topic = selectElement.options[selectElement.selectedIndex].text;
            titleElement.textContent = `Weekly Average Sentiment - ${topic}`;
            loadData(selectElement.value);
        });

        // Initial load
        loadData("palestine_sentiment.csv");
    </script>
</body>
</html>
